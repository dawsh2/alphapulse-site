<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0969da" id="theme-color">
    <title>Replay - AlphaPulse</title>
    
    <!-- Shared styles with Full Stack Open design -->
    <link rel="stylesheet" href="shared.css">
    
    <!-- TradingView Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
    
    <!-- Page-specific styles -->
    <style>
        /* Layout */
        .replay-container {
            display: grid;
            grid-template-columns: 3fr 1fr;
            height: calc(100vh - var(--header-height));
            overflow: hidden;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Chart Container */
        .chart-container {
            flex: 1;
            position: relative;
            background: var(--color-bg-primary);
            min-height: 300px;
        }
        
        #chart {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        /* Chart Overlay Info */
        .chart-info {
            position: absolute;
            top: var(--space-4);
            left: var(--space-4);
            background: rgba(var(--color-bg-secondary), 0.95);
            backdrop-filter: blur(10px);
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border-primary);
            z-index: 10;
            pointer-events: none;
        }
        
        .strategy-info {
            padding-bottom: var(--space-3);
            margin-bottom: var(--space-3);
            border-bottom: 1px solid var(--color-border-primary);
        }
        
        .strategy-name {
            font-weight: var(--font-weight-semibold);
            color: var(--color-accent-primary);
            font-size: var(--font-size-base);
        }
        
        .price-info {
            display: flex;
            gap: var(--space-4);
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }
        
        /* Control Panel */
        .control-panel {
            background: var(--color-bg-secondary);
            border-top: 1px solid var(--color-border-primary);
            padding: var(--space-4);
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }
        
        /* Playback Controls */
        .playback-controls {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            justify-content: center;
        }
        
        .play-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--color-accent-primary);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }
        
        .play-btn:hover {
            background: var(--color-text-link-hover);
            transform: scale(1.05);
        }
        
        .play-btn:active {
            transform: scale(0.95);
        }
        
        .play-btn.playing {
            background: var(--color-accent-danger);
        }
        
        .control-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border-primary);
            color: var(--color-text-primary);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }
        
        .control-btn:hover {
            background: var(--color-bg-primary);
            border-color: var(--color-border-secondary);
        }
        
        .control-btn:active {
            transform: scale(0.9);
        }
        
        /* Timeline */
        .timeline-container {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .timeline {
            flex: 1;
            height: 6px;
            background: var(--color-bg-tertiary);
            border-radius: 3px;
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }
        
        .timeline-progress {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: var(--color-accent-primary);
            border-radius: 3px;
            transition: width 0.1s;
        }
        
        .timeline-handle {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            background: white;
            border: 2px solid var(--color-accent-primary);
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .timeline-handle:active {
            cursor: grabbing;
        }
        
        .time-label {
            font-size: var(--font-size-xs);
            font-family: var(--font-family-mono);
            color: var(--color-text-secondary);
            min-width: 45px;
            text-align: center;
        }
        
        /* Speed Control */
        .speed-control {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            justify-content: center;
        }
        
        .speed-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }
        
        .speed-btn {
            padding: var(--space-1) var(--space-3);
            font-size: var(--font-size-xs);
        }
        
        /* Info Panel */
        .info-panel {
            background: var(--color-bg-secondary);
            border-top: 1px solid var(--color-border-primary);
            padding: var(--space-4);
            display: none;
        }
        
        .info-panel.open {
            display: block;
        }
        
        /* Event Log Panel */
        .event-log-panel {
            background: var(--color-bg-secondary);
            border-left: 1px solid var(--color-border-primary);
            padding: var(--space-4);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .event-log-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--color-border-primary);
            flex-shrink: 0;
        }
        
        .event-log-title {
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
            color: var(--color-text-primary);
        }
        
        .event-log-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            flex: 1;
            overflow-y: auto;
        }
        
        .event-item {
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            padding: var(--space-2);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            transition: background var(--transition-fast);
        }
        
        .event-item:hover {
            background: var(--color-bg-tertiary);
        }
        
        .event-time {
            font-family: var(--font-family-mono);
            font-size: var(--font-size-xs);
            color: var(--color-text-tertiary);
            min-width: 60px;
        }
        
        .event-type {
            font-weight: var(--font-weight-medium);
            text-transform: uppercase;
            font-size: var(--font-size-xs);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            min-width: 60px;
            text-align: center;
        }
        
        .event-type.buy {
            background: var(--color-accent-secondary);
            color: white;
        }
        
        .event-type.sell {
            background: var(--color-accent-danger);
            color: white;
        }
        
        .event-type.hold {
            background: var(--color-bg-tertiary);
            color: var(--color-text-secondary);
        }
        
        .event-description {
            flex: 1;
            color: var(--color-text-secondary);
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-3);
        }
        
        .info-item {
            background: var(--color-bg-tertiary);
            padding: var(--space-3);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border-primary);
        }
        
        .info-label {
            font-size: var(--font-size-xs);
            color: var(--color-text-tertiary);
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-wide);
            margin-bottom: var(--space-1);
        }
        
        .info-value {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
        }
        
        .info-value.positive {
            color: var(--color-accent-secondary);
        }
        
        .info-value.negative {
            color: var(--color-accent-danger);
        }
        
        /* Strategy Selector (Bottom Sheet) */
        .strategy-selector {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--color-bg-secondary);
            border-top: 1px solid var(--color-border-primary);
            border-radius: var(--radius-2xl) var(--radius-2xl) 0 0;
            transform: translateY(100%);
            transition: transform var(--transition-base);
            max-height: 60vh;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        
        .strategy-selector.open {
            transform: translateY(0);
        }
        
        .sheet-handle {
            padding: var(--space-3);
            cursor: pointer;
            text-align: center;
        }
        
        .sheet-handle-bar {
            width: 40px;
            height: 4px;
            background: var(--color-text-tertiary);
            border-radius: 2px;
            margin: 0 auto;
        }
        
        .strategy-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 var(--space-4) var(--space-4);
        }
        
        .strategy-item {
            display: flex;
            align-items: center;
            padding: var(--space-3);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border-primary);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-3);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .strategy-item:hover {
            border-color: var(--color-border-secondary);
            transform: translateX(-2px);
        }
        
        .strategy-item.active {
            background: var(--color-accent-primary);
            color: white;
            border-color: var(--color-accent-primary);
        }
        
        .strategy-icon {
            font-size: 24px;
            margin-right: var(--space-3);
        }
        
        .strategy-details {
            flex: 1;
        }
        
        .strategy-title {
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--space-1);
        }
        
        .strategy-meta {
            font-size: var(--font-size-xs);
            opacity: 0.8;
        }
        
        .strategy-stats {
            text-align: right;
            font-size: var(--font-size-xs);
        }
        
        .strategy-return {
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
        }
        
        /* Mobile Specific */
        @media (min-width: 768px) {
            .control-panel {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }
            
            .playback-controls {
                flex: 0 0 auto;
            }
            
            .timeline-container {
                flex: 1;
                max-width: 500px;
            }
            
            .speed-control {
                flex: 0 0 auto;
            }
        }
        
        @media (max-width: 768px) {
            .replay-container {
                height: calc(100vh - var(--mobile-header-height));
                grid-template-columns: 1fr;
                grid-template-rows: 1fr auto;
            }
            
            .event-log-panel {
                border-left: none;
                border-top: 1px solid var(--color-border-primary);
                max-height: 200px;
            }
            
            .chart-info {
                top: var(--space-3);
                left: var(--space-3);
                padding: var(--space-2) var(--space-3);
            }
            
            .control-panel {
                padding: var(--space-3);
                gap: var(--space-3);
            }
            
            .price-info {
                font-size: 10px;
                gap: var(--space-3);
            }
        }
        
        /* Loading State */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--color-text-secondary);
            z-index: 10;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto var(--space-3);
            border: 3px solid var(--color-border-primary);
            border-top: 3px solid var(--color-accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header will be injected by layout.js -->
        
        <div class="replay-container">
            <div class="main-content">
                <div class="chart-container">
                    <div id="chart"></div>
                    <div class="chart-info">
                        <div class="price-info">
                            <span id="currentPrice">$423.45</span>
                            <span id="currentTime">2024-01-15 10:30</span>
                        </div>
                    </div>
                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                        Loading market data...
                    </div>
                </div>
                
                <div class="control-panel">
                    <div class="playback-controls">
                        <button class="control-btn" onclick="skipBackward()">⏮</button>
                        <button class="play-btn" id="playBtn" onclick="togglePlay()">▶</button>
                        <button class="control-btn" onclick="skipForward()">⏭</button>
                    </div>
                    
                    <div class="timeline-container">
                        <span class="time-label" id="currentTimeLabel">0:00</span>
                        <div class="timeline" id="timeline" onclick="seekTimeline(event)">
                            <div class="timeline-progress" id="timelineProgress"></div>
                            <div class="timeline-handle" id="timelineHandle" style="left: 0%"></div>
                        </div>
                        <span class="time-label" id="totalTimeLabel">52:00</span>
                    </div>
                    
                    <div class="speed-control">
                        <span class="speed-label">Speed:</span>
                        <button class="btn btn-ghost speed-btn" onclick="setSpeed(0.5)">0.5x</button>
                        <button class="btn btn-ghost speed-btn active" onclick="setSpeed(1)">1x</button>
                        <button class="btn btn-ghost speed-btn" onclick="setSpeed(2)">2x</button>
                        <button class="btn btn-ghost speed-btn" onclick="setSpeed(5)">5x</button>
                    </div>
                </div>
            </div>
            
            <div class="event-log-panel" id="eventLogPanel">
                <div class="strategy-info">
                    <div class="strategy-name" id="strategyNameSidebar">Momentum Strategy</div>
                </div>
                <div class="event-log-header">
                    <h3 class="event-log-title">Event Log</h3>
                    <button class="btn btn-ghost btn-sm" onclick="clearEventLog()">Clear</button>
                </div>
                <div class="event-log-list" id="eventLogList">
                    <!-- Events will be populated here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Layout Manager -->
    <script src="layout.js"></script>
    
    <script>
        // Chart setup
        let chart;
        let candleSeries;
        let volumeSeries;
        let markerSeries;
        let currentBar = 0;
        let isPlaying = false;
        let playbackSpeed = 1;
        let playbackInterval;
        
        // Mock data
        const generateMockData = () => {
            const data = [];
            const basePrice = 420;
            const now = new Date();
            
            for (let i = 0; i < 390; i++) { // 390 minutes in trading day
                const time = new Date(now.getTime() - (390 - i) * 60000);
                const random = Math.random();
                const trend = Math.sin(i / 50) * 5;
                const noise = (random - 0.5) * 2;
                
                const open = basePrice + trend + noise + (i > 0 ? data[i-1].close - basePrice : 0) * 0.3;
                const close = open + (Math.random() - 0.5) * 1;
                const high = Math.max(open, close) + Math.random() * 0.5;
                const low = Math.min(open, close) - Math.random() * 0.5;
                const volume = Math.floor(1000000 + Math.random() * 2000000);
                
                const signal = i % 50 === 0 ? (Math.random() > 0.5 ? 'buy' : 'sell') : null;
                
                data.push({
                    time: Math.floor(time.getTime() / 1000),
                    open,
                    high,
                    low,
                    close,
                    volume,
                    signal
                });
                
                // Add event data
                if (signal) {
                    eventData.push({
                        time: time.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
                        type: signal,
                        description: `${signal.toUpperCase()} signal generated at $${close.toFixed(2)}`
                    });
                }
            }
            
            return data;
        };
        
        let marketData = [];
        let eventData = [];
        
        // Initialize chart
        function initChart() {
            // Check if LightweightCharts is loaded
            if (typeof LightweightCharts === 'undefined') {
                setTimeout(initChart, 100);
                return;
            }
            
            const chartElement = document.getElementById('chart');
            const theme = document.documentElement.getAttribute('data-theme') || 'light';
            const isDark = theme === 'dark';
            
            chart = LightweightCharts.createChart(chartElement, {
                width: chartElement.clientWidth,
                height: chartElement.clientHeight,
                layout: {
                    background: { color: isDark ? '#0d1117' : '#ffffff' },
                    textColor: isDark ? '#f0f6fc' : '#33332d',
                },
                grid: {
                    vertLines: { color: isDark ? '#30363d' : '#e1e1db' },
                    horzLines: { color: isDark ? '#30363d' : '#e1e1db' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                rightPriceScale: {
                    borderColor: isDark ? '#30363d' : '#e1e1db',
                },
                timeScale: {
                    borderColor: isDark ? '#30363d' : '#e1e1db',
                    timeVisible: true,
                    secondsVisible: false,
                },
            });
            
            candleSeries = chart.addCandlestickSeries({
                upColor: '#3fb950',
                downColor: '#f85149',
                borderUpColor: '#3fb950',
                borderDownColor: '#f85149',
                wickUpColor: '#3fb950',
                wickDownColor: '#f85149',
            });
            
            // Hide loading immediately
            const loadingEl = document.getElementById('loading');
            if (loadingEl) {
                loadingEl.style.display = 'none';
            }
            
            // Generate mock data if not already present
            if (!marketData || marketData.length === 0) {
                marketData = generateMockData();
            }
            
            // Start with first 50 bars
            updateChart(50);
            
            // Add header buttons
            addHeaderButtons();
        }
        
        // Add buttons to header
        function addHeaderButtons() {
            // No custom buttons needed - keeping banner identical across pages
        }
        
        // Update chart data
        function updateChart(bars) {
            const visibleData = marketData.slice(0, bars);
            candleSeries.setData(visibleData);
            
            // Add markers for signals
            const markers = visibleData
                .filter(d => d.signal)
                .map(d => ({
                    time: d.time,
                    position: d.signal === 'buy' ? 'belowBar' : 'aboveBar',
                    color: d.signal === 'buy' ? '#3fb950' : '#f85149',
                    shape: d.signal === 'buy' ? 'arrowUp' : 'arrowDown',
                    text: d.signal.toUpperCase()
                }));
            
            candleSeries.setMarkers(markers);
            
            // Update current price display
            const lastBar = visibleData[visibleData.length - 1];
            if (lastBar) {
                document.getElementById('currentPrice').textContent = `$${lastBar.close.toFixed(2)}`;
                document.getElementById('currentTime').textContent = 
                    new Date(lastBar.time * 1000).toLocaleString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
            }
            
            // Update timeline
            updateTimeline(bars);
            
            // Update event log
            updateEventLog(bars);
        }
        
        // Playback controls
        function togglePlay() {
            isPlaying = !isPlaying;
            const playBtn = document.getElementById('playBtn');
            
            if (isPlaying) {
                playBtn.textContent = '⏸';
                playBtn.classList.add('playing');
                startPlayback();
            } else {
                playBtn.textContent = '▶';
                playBtn.classList.remove('playing');
                stopPlayback();
            }
        }
        
        function startPlayback() {
            playbackInterval = setInterval(() => {
                if (currentBar < marketData.length) {
                    currentBar += 1;
                    updateChart(currentBar);
                } else {
                    // Reached end
                    togglePlay();
                    currentBar = marketData.length;
                }
            }, 100 / playbackSpeed);
        }
        
        function stopPlayback() {
            if (playbackInterval) {
                clearInterval(playbackInterval);
                playbackInterval = null;
            }
        }
        
        function skipBackward() {
            currentBar = Math.max(1, currentBar - 50);
            updateChart(currentBar);
        }
        
        function skipForward() {
            currentBar = Math.min(marketData.length, currentBar + 50);
            updateChart(currentBar);
        }
        
        function setSpeed(speed) {
            playbackSpeed = speed;
            
            // Update button states
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Restart playback if playing
            if (isPlaying) {
                stopPlayback();
                startPlayback();
            }
        }
        
        // Timeline controls
        function updateTimeline(bars) {
            const progress = (bars / marketData.length) * 100;
            document.getElementById('timelineProgress').style.width = progress + '%';
            document.getElementById('timelineHandle').style.left = progress + '%';
            
            // Update time labels
            const currentMinutes = Math.floor(bars / 60);
            const totalMinutes = Math.floor(marketData.length / 60);
            
            document.getElementById('currentTimeLabel').textContent = 
                `${Math.floor(currentMinutes / 60)}:${(currentMinutes % 60).toString().padStart(2, '0')}`;
            document.getElementById('totalTimeLabel').textContent = 
                `${Math.floor(totalMinutes / 60)}:${(totalMinutes % 60).toString().padStart(2, '0')}`;
            
            currentBar = bars;
        }
        
        function stepBackward() {
            if (currentBar > 1) {
                currentBar -= 1;
                updateChart(currentBar);
            }
        }
        
        function stepForward() {
            if (currentBar < marketData.length) {
                currentBar += 1;
                updateChart(currentBar);
            }
        }
        
        function seekTimeline(event) {
            const timeline = document.getElementById('timeline');
            const rect = timeline.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const percentage = Math.max(0, Math.min(100, (x / rect.width) * 100));
            const bars = Math.floor((percentage / 100) * marketData.length);
            
            currentBar = bars;
            updateChart(bars);
        }
        
        // UI Controls
        
        function clearEventLog() {
            const eventLogList = document.getElementById('eventLogList');
            eventLogList.innerHTML = '';
            eventData = [];
        }
        
        
        function loadStrategy(strategyId) {
            // Update active state
            document.querySelectorAll('.strategy-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // Update strategy name
            const strategyNames = {
                'momentum': 'Momentum Strategy',
                'meanreversion': 'Mean Reversion',
                'pairs': 'Pairs Trading',
                'ml': 'ML Ensemble'
            };
            document.getElementById('strategyNameSidebar').textContent = strategyNames[strategyId];
            
            // Generate new data for the strategy
            marketData = generateMockData();
            currentBar = 50;
            updateChart(currentBar);
            
            // Close selector
            closeStrategySelector();
            
            // Update stats
            updateStats();
        }
        
        function updateStats() {
            // Mock stats update
            const stats = {
                totalReturn: (Math.random() * 20 - 5).toFixed(2),
                winRate: (50 + Math.random() * 20).toFixed(1),
                positions: Math.floor(Math.random() * 5) + 1,
                maxDrawdown: -(Math.random() * 15).toFixed(1)
            };
            
            const returnEl = document.getElementById('totalReturn');
            returnEl.textContent = stats.totalReturn > 0 ? `+${stats.totalReturn}%` : `${stats.totalReturn}%`;
            returnEl.className = stats.totalReturn > 0 ? 'info-value positive' : 'info-value negative';
            
            document.getElementById('winRate').textContent = `${stats.winRate}%`;
            document.getElementById('positions').textContent = stats.positions;
            document.getElementById('maxDrawdown').textContent = `${stats.maxDrawdown}%`;
        }
        
        // Handle window resize
        window.addEventListener('resize', () => {
            if (chart) {
                chart.applyOptions({
                    width: document.getElementById('chart').clientWidth,
                    height: document.getElementById('chart').clientHeight
                });
            }
        });
        
        // Handle theme changes
        window.addEventListener('alphapulse:themechange', (e) => {
            if (chart) {
                // Store current state
                const oldBar = currentBar;
                const wasPlaying = isPlaying;
                
                // Stop playback if playing
                if (wasPlaying) {
                    togglePlay();
                }
                
                // Remove old chart
                chart.remove();
                chart = null;
                candleSeries = null;
                
                // Recreate chart with new theme
                initChart();
                updateChart(oldBar);
                
                // Resume playback if was playing
                if (wasPlaying) {
                    togglePlay();
                }
            }
        });
        
        // Update event log based on current position
        function updateEventLog(currentBar) {
            const eventLogList = document.getElementById('eventLogList');
            eventLogList.innerHTML = '';
            
            // Calculate how many events to show based on current bar
            const eventsToShow = Math.floor(currentBar / 50);
            const visibleEvents = eventData.slice(0, eventsToShow);
            
            // Add events in reverse order (newest first)
            visibleEvents.reverse().forEach(event => {
                const eventItem = document.createElement('div');
                eventItem.className = 'event-item';
                eventItem.innerHTML = `
                    <span class="event-time">${event.time}</span>
                    <span class="event-type ${event.type}">${event.type}</span>
                    <span class="event-description">${event.description}</span>
                `;
                eventLogList.appendChild(eventItem);
            });
            
            // Add a message if no events yet
            if (visibleEvents.length === 0) {
                eventLogList.innerHTML = '<p style="text-align: center; color: var(--color-text-tertiary); font-size: var(--font-size-sm);">No events yet</p>';
            }
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            // Generate data first
            marketData = generateMockData();
            
            // Initialize chart
            initChart();
            updateStats();
            
            // Set initial timeline
            currentBar = 50;
            updateTimeline(currentBar);
            
            // Initialize event log
            updateEventLog(currentBar);
        });
        
        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.shiftKey) {
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    stepBackward();
                } else if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    stepForward();
                }
            }
        });
    </script>
</body>
</html>