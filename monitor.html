<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0969da" id="theme-color">
    <title>Monitor - AlphaPulse</title>
    
    <!-- Shared styles with Full Stack Open design -->
    <link rel="stylesheet" href="shared.css">
    
    <!-- TradingView Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
    
    <!-- Page-specific styles -->
    <style>
        /* Layout */
        .monitor-container {
            display: grid;
            grid-template-rows: auto 1fr;
            height: calc(100vh - var(--header-height));
            overflow: hidden;
        }
        
        /* Mode Selector */
        .mode-selector {
            background: var(--color-bg-secondary);
            border-bottom: 1px solid var(--color-border-primary);
            padding: var(--space-3) var(--space-4);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-4);
        }
        
        .mode-tabs {
            display: flex;
            gap: var(--space-2);
            background: var(--color-bg-tertiary);
            padding: var(--space-1);
            border-radius: var(--radius-md);
        }
        
        .mode-tab {
            padding: var(--space-2) var(--space-4);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-secondary);
            background: none;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .mode-tab:hover {
            color: var(--color-text-primary);
            background: var(--color-bg-secondary);
        }
        
        .mode-tab.active {
            color: var(--color-text-primary);
            background: var(--color-bg-primary);
            box-shadow: var(--shadow-sm);
        }
        
        .mode-info {
            display: flex;
            align-items: center;
            gap: var(--space-6);
        }
        
        .mode-status {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--font-size-sm);
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-accent-secondary);
        }
        
        .status-indicator.inactive {
            background: var(--color-text-tertiary);
        }
        
        .status-indicator.warning {
            background: var(--color-accent-warning);
        }
        
        /* Content Area */
        .content-area {
            display: grid;
            grid-template-columns: 3fr 1fr;
            overflow: hidden;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Chart Container */
        .chart-container {
            flex: 1;
            position: relative;
            background: var(--color-bg-primary);
            min-height: 300px;
        }
        
        #chart {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        /* Chart Overlay Info */
        .chart-info {
            position: absolute;
            top: var(--space-4);
            left: var(--space-4);
            background: rgba(var(--color-bg-primary-rgb), 0.9);
            backdrop-filter: blur(8px);
            border: 1px solid var(--color-border-primary);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            min-width: 200px;
            z-index: 10;
        }
        
        .symbol-info {
            display: flex;
            align-items: baseline;
            gap: var(--space-2);
            margin-bottom: var(--space-2);
        }
        
        .symbol {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
        }
        
        .timeframe {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }
        
        .price-info {
            display: grid;
            grid-template-columns: auto auto;
            gap: var(--space-2) var(--space-4);
            font-size: var(--font-size-sm);
        }
        
        .price-label {
            color: var(--color-text-tertiary);
        }
        
        .price-value {
            font-family: var(--font-family-mono);
            color: var(--color-text-primary);
            text-align: right;
        }
        
        /* Controls Bar */
        .controls-bar {
            background: var(--color-bg-secondary);
            border-top: 1px solid var(--color-border-primary);
            padding: var(--space-3) var(--space-4);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-4);
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .control-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }
        
        /* Replay Controls */
        .replay-controls {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .replay-btn {
            padding: var(--space-2);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border-primary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .replay-btn:hover {
            background: var(--color-bg-primary);
            border-color: var(--color-border-secondary);
        }
        
        .replay-btn.active {
            background: var(--color-accent-primary);
            border-color: var(--color-accent-primary);
            color: white;
        }
        
        .replay-btn svg {
            width: 16px;
            height: 16px;
        }
        
        .speed-selector {
            padding: var(--space-1) var(--space-3);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border-primary);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            cursor: pointer;
        }
        
        /* Sidebar */
        .sidebar {
            background: var(--color-bg-secondary);
            border-left: 1px solid var(--color-border-primary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid var(--color-border-primary);
        }
        
        .sidebar-tab {
            flex: 1;
            padding: var(--space-3);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            text-align: center;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .sidebar-tab:hover {
            color: var(--color-text-primary);
        }
        
        .sidebar-tab.active {
            color: var(--color-accent-primary);
            border-bottom-color: var(--color-accent-primary);
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-4);
        }
        
        /* Metrics Panel */
        .metrics-grid {
            display: grid;
            gap: var(--space-4);
        }
        
        .metric-card {
            background: var(--color-bg-tertiary);
            border-radius: var(--radius-md);
            padding: var(--space-3);
        }
        
        .metric-label {
            font-size: var(--font-size-xs);
            color: var(--color-text-tertiary);
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-wide);
            margin-bottom: var(--space-1);
        }
        
        .metric-value {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            font-family: var(--font-family-mono);
        }
        
        .metric-value.positive {
            color: var(--color-accent-secondary);
        }
        
        .metric-value.negative {
            color: var(--color-accent-danger);
        }
        
        /* Strategy List */
        .strategy-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }
        
        .strategy-item {
            background: var(--color-bg-tertiary);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .strategy-item:hover {
            background: var(--color-bg-primary);
            transform: translateX(-2px);
        }
        
        .strategy-item.active {
            background: var(--color-accent-primary);
            color: white;
        }
        
        .strategy-name {
            font-weight: var(--font-weight-medium);
            margin-bottom: var(--space-1);
        }
        
        .strategy-stats {
            display: flex;
            gap: var(--space-3);
            font-size: var(--font-size-xs);
            opacity: 0.8;
        }
        
        /* Event Log */
        .event-log {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }
        
        .event-item {
            display: flex;
            gap: var(--space-2);
            padding: var(--space-2) 0;
            border-bottom: 1px solid var(--color-border-primary);
            font-size: var(--font-size-sm);
        }
        
        .event-time {
            font-family: var(--font-family-mono);
            color: var(--color-text-tertiary);
            font-size: var(--font-size-xs);
        }
        
        .event-type {
            padding: var(--space-1) var(--space-2);
            background: var(--color-bg-tertiary);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-wide);
        }
        
        .event-type.buy {
            background: rgba(63, 185, 80, 0.15);
            color: var(--color-accent-secondary);
        }
        
        .event-type.sell {
            background: rgba(248, 81, 73, 0.15);
            color: var(--color-accent-danger);
        }
        
        .event-message {
            flex: 1;
            color: var(--color-text-secondary);
        }
        
        /* Hide mode-specific content */
        .replay-only,
        .deploy-only {
            display: none;
        }
        
        .mode-replay .replay-only {
            display: flex;
        }
        
        .mode-deploy .deploy-only {
            display: flex;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .content-area {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
            }
        }
        
        @media (max-width: 768px) {
            .mode-info {
                display: none;
            }
            
            .controls-bar {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header will be injected by layout.js -->
        
        <main class="main" style="padding: 0;">
            <div class="monitor-container">
                <!-- Mode Selector -->
                <div class="mode-selector">
                    <div class="mode-tabs">
                        <button class="mode-tab active" data-mode="replay">Replay</button>
                        <button class="mode-tab" data-mode="deploy">Deploy</button>
                    </div>
                    
                    <div class="mode-info">
                        <div class="mode-status replay-only">
                            <span class="status-indicator"></span>
                            <span>Replay Mode</span>
                        </div>
                        <div class="mode-status deploy-only">
                            <span class="status-indicator"></span>
                            <span>Live Trading</span>
                        </div>
                        <div class="control-group">
                            <label class="control-label">Account:</label>
                            <select class="form-select form-select-sm" id="account-selector">
                                <option>Paper Trading</option>
                                <option>Live Account</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Content Area -->
                <div class="content-area">
                    <div class="main-content">
                        <!-- Chart -->
                        <div class="chart-container">
                            <div id="chart"></div>
                            
                            <div class="chart-info">
                                <div class="symbol-info">
                                    <span class="symbol">SPY</span>
                                    <span class="timeframe">5m</span>
                                </div>
                                <div class="price-info">
                                    <span class="price-label">O</span>
                                    <span class="price-value">423.45</span>
                                    <span class="price-label">H</span>
                                    <span class="price-value">424.78</span>
                                    <span class="price-label">L</span>
                                    <span class="price-value">422.90</span>
                                    <span class="price-label">C</span>
                                    <span class="price-value">424.12</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Controls Bar -->
                        <div class="controls-bar">
                            <!-- Replay Controls -->
                            <div class="control-group replay-only">
                                <label class="control-label">Replay:</label>
                                <div class="replay-controls">
                                    <button class="replay-btn" id="replay-backward">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polygon points="11 19 2 12 11 5 11 19"></polygon>
                                            <polygon points="22 19 13 12 22 5 22 19"></polygon>
                                        </svg>
                                    </button>
                                    <button class="replay-btn" id="replay-play">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                        </svg>
                                    </button>
                                    <button class="replay-btn" id="replay-forward">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polygon points="13 19 22 12 13 5 13 19"></polygon>
                                            <polygon points="2 19 11 12 2 5 2 19"></polygon>
                                        </svg>
                                    </button>
                                    <select class="speed-selector">
                                        <option>1x</option>
                                        <option>2x</option>
                                        <option>5x</option>
                                        <option>10x</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Symbol & Timeframe -->
                            <div class="control-group">
                                <input type="text" class="form-input form-input-sm" placeholder="Symbol" value="SPY" style="width: 80px;">
                                <select class="form-select form-select-sm">
                                    <option>1m</option>
                                    <option selected>5m</option>
                                    <option>15m</option>
                                    <option>1h</option>
                                    <option>1d</option>
                                </select>
                            </div>
                            
                            <!-- Strategy Selector -->
                            <div class="control-group">
                                <label class="control-label">Strategy:</label>
                                <select class="form-select form-select-sm" style="width: 200px;">
                                    <option>Mean Reversion v2</option>
                                    <option>Momentum Breakout</option>
                                    <option>Market Making</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sidebar -->
                    <div class="sidebar">
                        <div class="sidebar-tabs">
                            <button class="sidebar-tab active" data-tab="metrics">Metrics</button>
                            <button class="sidebar-tab" data-tab="events">Events</button>
                            <button class="sidebar-tab" data-tab="strategies">Strategies</button>
                        </div>
                        
                        <div class="sidebar-content">
                            <!-- Metrics Tab -->
                            <div class="tab-panel active" data-panel="metrics">
                                <div class="metrics-grid">
                                    <div class="metric-card">
                                        <div class="metric-label">Total P&L</div>
                                        <div class="metric-value positive">+$2,345.67</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-label">Win Rate</div>
                                        <div class="metric-value">68.4%</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-label">Sharpe Ratio</div>
                                        <div class="metric-value">1.82</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-label">Max Drawdown</div>
                                        <div class="metric-value negative">-8.3%</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-label">Total Trades</div>
                                        <div class="metric-value">247</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-label">Avg Trade</div>
                                        <div class="metric-value positive">+$9.49</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Events Tab -->
                            <div class="tab-panel" data-panel="events" style="display: none;">
                                <div class="event-log">
                                    <div class="event-item">
                                        <span class="event-time">14:32:15</span>
                                        <span class="event-type buy">BUY</span>
                                        <span class="event-message">100 SPY @ 424.12</span>
                                    </div>
                                    <div class="event-item">
                                        <span class="event-time">14:28:43</span>
                                        <span class="event-type sell">SELL</span>
                                        <span class="event-message">100 SPY @ 423.89</span>
                                    </div>
                                    <div class="event-item">
                                        <span class="event-time">14:15:22</span>
                                        <span class="event-type">SIGNAL</span>
                                        <span class="event-message">Momentum detected</span>
                                    </div>
                                    <div class="event-item">
                                        <span class="event-time">14:10:05</span>
                                        <span class="event-type buy">BUY</span>
                                        <span class="event-message">100 SPY @ 423.45</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Strategies Tab -->
                            <div class="tab-panel" data-panel="strategies" style="display: none;">
                                <div class="strategy-list">
                                    <div class="strategy-item active">
                                        <div class="strategy-name">Mean Reversion v2</div>
                                        <div class="strategy-stats">
                                            <span>Win: 68%</span>
                                            <span>P&L: +12.3%</span>
                                        </div>
                                    </div>
                                    <div class="strategy-item">
                                        <div class="strategy-name">Momentum Breakout</div>
                                        <div class="strategy-stats">
                                            <span>Win: 52%</span>
                                            <span>P&L: +8.7%</span>
                                        </div>
                                    </div>
                                    <div class="strategy-item">
                                        <div class="strategy-name">Market Making</div>
                                        <div class="strategy-stats">
                                            <span>Win: 71%</span>
                                            <span>P&L: +5.2%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Layout Manager -->
    <script src="layout.js"></script>
    
    <!-- Page-specific scripts -->
    <script>
        // State variables
        let chart = null;
        let candleSeries = null;
        let marketData = [];
        let eventData = [];
        let currentBar = 50;
        let isPlaying = false;
        let playbackInterval = null;
        let playbackSpeed = 1;
        
        // Generate mock data
        const generateMockData = () => {
            const data = [];
            const basePrice = 420;
            const now = new Date();
            
            for (let i = 0; i < 390; i++) { // 390 minutes in trading day
                const time = new Date(now.getTime() - (390 - i) * 60000);
                const random = Math.random();
                const trend = Math.sin(i / 50) * 5;
                const noise = (random - 0.5) * 2;
                
                const open = basePrice + trend + noise + (i > 0 ? data[i-1].close - basePrice : 0) * 0.3;
                const close = open + (Math.random() - 0.5) * 1;
                const high = Math.max(open, close) + Math.random() * 0.5;
                const low = Math.min(open, close) - Math.random() * 0.5;
                const volume = Math.floor(1000000 + Math.random() * 2000000);
                
                const signal = i % 50 === 0 ? (Math.random() > 0.5 ? 'buy' : 'sell') : null;
                
                data.push({
                    time: Math.floor(time.getTime() / 1000),
                    open,
                    high,
                    low,
                    close,
                    volume,
                    signal
                });
                
                // Add event data
                if (signal) {
                    eventData.push({
                        time: time.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
                        type: signal,
                        description: `${signal.toUpperCase()} signal generated at $${close.toFixed(2)}`
                    });
                }
            }
            
            return data;
        };
        
        // Initialize chart
        function initChart() {
            // Check if LightweightCharts is loaded
            if (typeof LightweightCharts === 'undefined') {
                setTimeout(initChart, 100);
                return;
            }
            
            const chartElement = document.getElementById('chart');
            const theme = document.documentElement.getAttribute('data-theme') || 'light';
            const isDark = theme === 'dark';
            
            chart = LightweightCharts.createChart(chartElement, {
                width: chartElement.clientWidth,
                height: chartElement.clientHeight,
                layout: {
                    background: { color: isDark ? '#1e2028' : '#faf8f3' },
                    textColor: isDark ? '#f0f6fc' : '#33332d',
                },
                grid: {
                    vertLines: { color: isDark ? '#383c45' : '#e5e0d5' },
                    horzLines: { color: isDark ? '#383c45' : '#e5e0d5' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                    vertLine: {
                        color: isDark ? '#4d525b' : '#d8d2c4',
                        width: 1,
                        style: 3,
                        labelBackgroundColor: isDark ? '#262931' : '#f5f2ea'
                    },
                    horzLine: {
                        color: isDark ? '#4d525b' : '#d8d2c4',
                        width: 1,
                        style: 3,
                        labelBackgroundColor: isDark ? '#262931' : '#f5f2ea'
                    }
                },
                rightPriceScale: {
                    borderColor: isDark ? '#383c45' : '#e5e0d5',
                    backgroundColor: isDark ? '#1e2028' : '#faf8f3',
                },
                timeScale: {
                    borderColor: isDark ? '#383c45' : '#e5e0d5',
                    backgroundColor: isDark ? '#1e2028' : '#faf8f3',
                    timeVisible: true,
                    secondsVisible: false,
                },
            });
            
            candleSeries = chart.addCandlestickSeries({
                upColor: '#3fb950',
                downColor: '#f85149',
                borderUpColor: '#3fb950',
                borderDownColor: '#f85149',
                wickUpColor: '#3fb950',
                wickDownColor: '#f85149',
            });
            
            // Generate mock data if not already present
            if (!marketData || marketData.length === 0) {
                marketData = generateMockData();
            }
            
            // Start with first 50 bars
            updateChart(50);
        }
        
        // Update chart data
        function updateChart(bars) {
            const visibleData = marketData.slice(0, bars);
            candleSeries.setData(visibleData);
            
            // Add markers for signals
            const markers = visibleData
                .filter(d => d.signal)
                .map(d => ({
                    time: d.time,
                    position: d.signal === 'buy' ? 'belowBar' : 'aboveBar',
                    color: d.signal === 'buy' ? '#3fb950' : '#f85149',
                    shape: d.signal === 'buy' ? 'arrowUp' : 'arrowDown',
                    text: d.signal.toUpperCase()
                }));
            
            candleSeries.setMarkers(markers);
            
            // Update price info
            const lastBar = visibleData[visibleData.length - 1];
            if (lastBar) {
                document.querySelector('.price-value').textContent = lastBar.open.toFixed(2);
                document.querySelectorAll('.price-value')[1].textContent = lastBar.high.toFixed(2);
                document.querySelectorAll('.price-value')[2].textContent = lastBar.low.toFixed(2);
                document.querySelectorAll('.price-value')[3].textContent = lastBar.close.toFixed(2);
            }
            
            currentBar = bars;
            updateEventLog(bars);
        }
        
        // Update event log based on current position
        function updateEventLog(currentBar) {
            const eventContainer = document.querySelector('.event-log');
            if (!eventContainer) return;
            
            eventContainer.innerHTML = '';
            
            // Calculate how many events to show based on current bar
            const eventsToShow = Math.floor(currentBar / 50);
            const visibleEvents = eventData.slice(0, eventsToShow);
            
            // Add events in reverse order (newest first)
            visibleEvents.reverse().forEach(event => {
                const eventItem = document.createElement('div');
                eventItem.className = 'event-item';
                eventItem.innerHTML = `
                    <span class="event-time">${event.time}</span>
                    <span class="event-type ${event.type}">${event.type}</span>
                    <span class="event-message">${event.description}</span>
                `;
                eventContainer.appendChild(eventItem);
            });
        }
        
        // Playback controls
        function togglePlay() {
            isPlaying = !isPlaying;
            const playBtn = document.getElementById('replay-play');
            
            if (isPlaying) {
                playBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="6" y="4" width="4" height="16"></rect>
                        <rect x="14" y="4" width="4" height="16"></rect>
                    </svg>
                `;
                playBtn.classList.add('active');
                startPlayback();
            } else {
                playBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                `;
                playBtn.classList.remove('active');
                stopPlayback();
            }
        }
        
        function startPlayback() {
            playbackInterval = setInterval(() => {
                if (currentBar < marketData.length) {
                    currentBar += 1;
                    updateChart(currentBar);
                } else {
                    // Reached end
                    togglePlay();
                    currentBar = marketData.length;
                }
            }, 100 / playbackSpeed);
        }
        
        function stopPlayback() {
            if (playbackInterval) {
                clearInterval(playbackInterval);
                playbackInterval = null;
            }
        }
        
        function skipBackward() {
            currentBar = Math.max(1, currentBar - 50);
            updateChart(currentBar);
        }
        
        function skipForward() {
            currentBar = Math.min(marketData.length, currentBar + 50);
            updateChart(currentBar);
        }
        
        // Mode switching
        const modeButtons = document.querySelectorAll('.mode-tab');
        const container = document.querySelector('.monitor-container');
        
        modeButtons.forEach(button => {
            button.addEventListener('click', () => {
                const mode = button.dataset.mode;
                
                // Update active button
                modeButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                // Update container class
                container.classList.remove('mode-replay', 'mode-deploy');
                container.classList.add(`mode-${mode}`);
                
                // Regenerate data for deploy mode
                if (mode === 'deploy') {
                    marketData = generateMockData();
                    updateChart(marketData.length);
                }
            });
        });
        
        // Set initial mode
        container.classList.add('mode-replay');
        
        // Sidebar tabs
        const sidebarTabs = document.querySelectorAll('.sidebar-tab');
        const tabPanels = document.querySelectorAll('.tab-panel');
        
        sidebarTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetPanel = tab.dataset.tab;
                
                // Update active tab
                sidebarTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Update active panel
                tabPanels.forEach(panel => {
                    if (panel.dataset.panel === targetPanel) {
                        panel.style.display = 'block';
                    } else {
                        panel.style.display = 'none';
                    }
                });
            });
        });
        
        // Replay controls
        document.getElementById('replay-play').addEventListener('click', togglePlay);
        document.getElementById('replay-backward').addEventListener('click', skipBackward);
        document.getElementById('replay-forward').addEventListener('click', skipForward);
        
        // Speed selector
        document.querySelector('.speed-selector').addEventListener('change', (e) => {
            playbackSpeed = parseInt(e.target.value);
            if (isPlaying) {
                stopPlayback();
                startPlayback();
            }
        });
        
        // Handle window resize
        window.addEventListener('resize', () => {
            if (chart) {
                chart.applyOptions({
                    width: document.getElementById('chart').clientWidth,
                    height: document.getElementById('chart').clientHeight
                });
            }
        });
        
        // Handle theme changes
        window.addEventListener('alphapulse:themechange', (e) => {
            if (chart) {
                // Store current state
                const oldBar = currentBar;
                const wasPlaying = isPlaying;
                
                // Stop playback if playing
                if (wasPlaying) {
                    togglePlay();
                }
                
                // Remove old chart
                chart.remove();
                chart = null;
                candleSeries = null;
                
                // Recreate chart with new theme
                initChart();
                updateChart(oldBar);
                
                // Resume playback if was playing
                if (wasPlaying) {
                    togglePlay();
                }
            }
        });
        
        // Initialize on load
        window.addEventListener('load', () => {
            // Generate data first
            marketData = generateMockData();
            
            // Initialize chart
            initChart();
            
            // Set initial timeline
            currentBar = 50;
        });
        
        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.shiftKey) {
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    if (currentBar > 1) {
                        currentBar -= 1;
                        updateChart(currentBar);
                    }
                } else if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    if (currentBar < marketData.length) {
                        currentBar += 1;
                        updateChart(currentBar);
                    }
                }
            }
        });
    </script>
</body>
</html>